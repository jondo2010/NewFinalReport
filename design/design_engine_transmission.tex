\section{Engine and Transmission Module}

The engine and transmission module provides optimized selection of the variable-length intake, changes gears at the driver's request without requiring manual clutching, and provides transmission features that make driving easier. Figure \ref{fig:design_engine_overview} shows an overview of the engine and transmission module and it's interactions with the environment.

\begin{figure}[H]
	\centering
	\input{design/figures/engine_overview_block}
	\caption{An overview of the engine and transmission module and it's environmental interactions.}
	\label{fig:design_engine_overview_block}
\end{figure}

The intake runner position is mechanically actuated with a \emph{servo motor}. The module generates the control signals required by electro-pneumatic system to actuate both the clutch and shift levers. The ECU interfaces with the module both directly through discrete inputs and through the CAN bus.

\subsection{Processes}

The major processes of the engine and transmission module are \emph{up-shifting}, \emph{down-shifting}, and \emph{neutral find}. They are described at a high level using flow charts. Requests to perform these processes are broadcast over the network from the driver interface. The module listens for these requests and executes the correct process accordingly.

\subsubsection{Up-shifting}

The up-shift procedure is described in \ref{fig:transmission_upshift_flow}. Up-shifting does not require disengaging the clutch, merely a small decrease in engine RPM. The ECU provides a shift-cut feature to cut spark to the engine during a shift operation to avoid the driver having to manually modulate the throttle during a shift.

\begin{figure}[H]
	\centering
	\input{design/figures/transmission_upshift_flow}
	\caption{Transmission upshift procedure.}
	\label{fig:transmission_upshift_flow}
\end{figure}

The up-shift process depends upon engine RPM and gear position, both of which are provided by the ECU. The shift-cut feature is engaged on the ECU to drop the engine RPM by a small amount known as the cut RPM threshold, or $RPM^{TH}_{cut}$. The exact value of $RPM^{TH}_{cut}$ can be tuned on the ECU. Once the RPM reaches the cut threshold, the upshift solenoid is engaged, which actuates the pneumatics to push the shift lever. Once the module receives notification that the current gear has incremented, the pneumatics are relaxed, and shift cut feature is disengaged.

\nomenclature{$RPM^{TH}_{cut}$}{The threshold RPM is expected to drop when shift-cut is engaged for no-lift up-shifting.}

\subsubsection{Down-shifting}

The down-shift procedure is described in \ref{fig:transmission_downshift_flow}. Unlike up-shifting, down-shifting requires disengaging the clutch, merely a small decrease in engine RPM. The ECU provides a shift-cut feature to cut spark to the engine during a shift operation to avoid the driver having to manually modulate the throttle during a shift.

When the Transmission Manager receives a down-shift request over the network, similar to the up-shift request handling, it creates asynchronous events in the Event Scheduler to respond to the request. Figure \ref{fig:transmission_downshift_flow} shows the flow chart of the downshift procedure. Clutch engagement and disengagement is handled asynchronously by the Clutch Controller. The downshift procedure differs from the upshift procedure in that the downshift requires use of the clutch, as well as two asynchronous incoming events from the driver:

\begin{enumerate}
  \item The original downshift request, when the driver pulls and holds the downshift paddle on the steering wheel, and
  \item a clutch engagement request, issued when the driver releases the downshift paddle.
\end{enumerate}

Adding this extra clutch engagement request allows the driver to delay re-engagement of the clutch so that they can blip the throttle to avoid engine compression and the possibility of a spinout when the clutch plates re-engage (this was explained in Sec. \ref{sec:background_transmission}.)

Additionally, a minimum clutch disengagement time $t^{clutch}_{min}$ is observed (another tunable parameter) in the event the driver pulls the paddle and releases it without any delay.

\nomenclature{$t^{clutch}_{min}$}{Minimum clutch disengagement time during a downshift request.}

\begin{figure}[H]
\centering
\input{design/figures/transmission_downshift_flow}
\caption{Transmission downshift procedure.}
\label{fig:transmission_downshift_flow}
\end{figure}

\subsubsection{Variable Intake}

\subsubsection{Gear Selection \label{sec:design_engine_transmission_gear_selection}}


\subsubsection{Advanced Transmission Features}

\begin{description}

\item[Auto Upshift Feature]

This feature of the engine module is aimed primarily at improving performance in the acceleration event. Based on known torque curves, a table of optimal shift points in the RPM range is developed. As the engine reaches the top RPM for a given gear, the engine module will automatically upshift to the next gear, without any driver input. All the driver needs to do is maintain full throttle, and hold on.

\item[Launch]
Full-throttle launch uses an important feature of the ECU called launch control. From a stand-still, the slip ratio of the driven wheels to the non-driven wheels is monitored, and the engine output power is reduced until the ratio reaches 1:1. Drivers use this feature by maintaining full-throttle at the starting line while holding the brake pedal. As soon as the brake pedal is released, the the engine module will release the clutch in a controlled manner in an attempt to get the best possible acceleration.

\item[Crawl]
Part-throttle launch is a feature designed to mimic an automatic transmission. By controlling the clutch position, and thereby modulating the amount of torque transferred to the wheels for a short period of time, the car can be made to creep slowly from a standstill. This will be used when driving up to the starting line of various dynamic events.

\item[Neutral Find]
As drivers come in to the pits from driving the course, a useful feature is the ability for the car to shift the transmission back into neutral to avoid stalling the car. The neutral find feature will automatically downshift the transmission repeatedly until it finds neutral.

\end{description}


\subsection{Software}

Software overview diagram


\subsubsection{Transmission Manager}

Listens to transmission requests from the driver over the network.

Uses the event scheduler to sequence the complex series of actuation vectors required by upshifting and downshifting.

Implement the PID feedback controller used to actuate the pneumatic system.

Interacts with the PWM generator to create the control signals required to actuate the pneumatic system.


\subsubsection{Intake Manager}

Continously monitor engine RPM and throttle position through messages from the ECU.

Will adjust intake runner length based on a functional map of RPM and throttle position.

Use hysterisis to avoid instability.

Map will be generated through dynometer testing.


\subsubsection{Starter Manager}

Listen for driver requests to start the engine.

Provide a means of one-touch starting -- sequences the actual starting of the engine through the solenoid driver. 


\subsubsection{Event Scheduler}

Allow for complex sequencing of events in time.

Controllers may schedule new events to occur at various points in time.

Scheduler will continuously update the schedule and signal the main control loop to execute events that are now current.


\subsubsection{CAN Interface}

Provide a means of interfacing with the physical bus. 

Allow direction of particular messages to particular modules.


\subsubsection{PWM Generator}

Generate PWM signals of at least 20 Hz with a resolution of 1\% duty
cycle.

Two-channel design


\subsubsection{Main Control Loop}

Initializes the system and brings into a known state.

Waits for pending events to be executed and executes them.

Monitor for system faults and react accordingly.


\subsection{Hardware}

Show system hardware diagram


\subsubsection{Microcontroller}

Execute system control software.

In-circuit programmable and debuggable.

Has built-in CAN controller.

Has built-in RAM and ROM as well as EEPROM for holding configuration parameters.


\subsubsection{CAN transceiver}

Interface module with the CAN bus.

Be capable of terminating the bus.


\subsubsection{High current solenoid drivers}


Controlling pneumatic solenoid valves (4)

Controlling starter solenoid


\subsubsection{I/O lines to the ECU}

The engine and transmission module has a several CMOS-level outputs to discrete control pins on the ECU:

\begin{itemize}
  \item A line to the launch control pin, which when toggled enables and disables the launch control feature,
  \item A line to the shift cut pin, which when held high enables shift cut, decreasing engine power to allow for an upshift,
  \item A line to the traction cut percent pin, which is a \unit{0-5}{\volt} level signalled input changing the amount of acceptable wheel slip before traction control cuts in.
  \item A line to the traction control on/off pin, which toggles the traction control feature,
  \item A line to the traction control wet/dry pin, which swaps between two traction control presets.
\end{itemize}

The outputs of these lines are controlled in the system software through the event scheduler. 